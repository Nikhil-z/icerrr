if(!site){var site={};}
site.detailstation={};site.detailstation.init=function(resultitem,forceRedraw,restoreLast){loggr.debug("------------------------------------");loggr.debug("site.detailstation.init()");site.ui.hideloading();if(restoreLast&&!resultitem&&site.detailstation.station_id){resultitem={station_id:site.detailstation.station_id};}
if(!resultitem){loggr.warn(" > !resultitem",{dontsave:true});return;}
if(!resultitem.station_id){loggr.warn(" > !resultitem.station_id",{dontsave:true});return;}
site.detailstation.station_id=resultitem.station_id;site.detailstation.station=site.helpers.session.getStationById(resultitem.station_id);site.lifecycle.add_section_history("#detailstation");site.ui.gotosection("#detailstation");site.lifecycle.addOnPauseCb(site.detailstation.onpause);site.lifecycle.addOnResumeCb(site.detailstation.onresume);site.detailstation.hideRecentlyPlayed();site.detailstation.updatedata();}
site.detailstation.onpause=function(){loggr.debug("site.detailstation.onpause()");if(site.detailstation.nowPlayingAjaxReqIdentifier){loggr.log(" > Cancel nowplaying request..");site.webapi.abort(site.detailstation.nowPlayingAjaxReqIdentifier);}}
site.detailstation.onresume=function(){loggr.log("site.detailstation.onresume()");if(site.detailstation.loadedStationData&&site.detailstation.loadedNowPlaying){site.detailstation.updatedata();}}
site.detailstation.updatedata=function(){loggr.debug("site.detailstation.updatedata()");site.detailstation.stationDirble=null;site.detailstation.stationPlaylist=null
site.detailstation.loadedNowPlaying=false;site.detailstation.loadedStationData=false;$("#detailstation .content").css("display","none");$("#detailstation .content_loading").css("display","block");site.ui.showLoadbar("#detailstation");if(site.detailstation.station.station_icon_local){loggr.log(" > Local icon :D "+site.detailstation.station.station_icon_local);$("#detailstation .station_icon img").attr("src",site.detailstation.station.station_icon_local);}else{loggr.warn(" > No local icon :(",{dontsave:true});$("#detailstation .station_icon img").attr("src","img/ic_station_default.png");}
$("#detailstation .station_image img").off("error");$("#detailstation .station_image img").on("error",function(evt){loggr.error(" -> DAFAQUE NOT WORKING?");$("#detailstation .station_image img").attr("src","img/web_hi_res_512_002.jpg");$("#detailstation .main .header").css("background-image","url('img/bg_home_default.jpg')");});if(site.detailstation.station.station_image_local){$("#detailstation .station_image img").attr("src",site.detailstation.station.station_image_local);}else{site.chicon.downloadImagery(site.detailstation.station,function(station_data){if(station_data){site.detailstation.station=station_data;if(site.detailstation.station.station_image_local){$("#detailstation .station_image img").attr("src",site.detailstation.station.station_image_local);}else if(site.detailstation.station.station_icon_local){$("#detailstation .station_image img").attr("src",site.detailstation.station.station_icon_local);}else{$("#detailstation .station_image img").attr("src","img/web_hi_res_512_002.jpg");}
if(site.detailstation.station.station_image_local){$("#detailstation .main .header").css("background-image","url('"+site.detailstation.station.station_image_local+"')");}else{$("#detailstation .main .header").css("background-image","url('img/bg_home_default.jpg')");}}else{loggr.warn("detailstation > chicon.downloadImagery.cb no station_data");}},function(err){loggr.warn("detailstation > chicon.downloadImagery.err: "+err);$("#detailstation .station_image img").attr("src","img/web_hi_res_512_002.jpg");});}
if(site.detailstation.station.station_image_local){$("#detailstation .main .header").css("background-image","url('"+site.detailstation.station.station_image_local+"')");}else{$("#detailstation .main .header").css("background-image","url('img/bg_home_default.jpg')");}
$("#detailstation .station_name").html(site.detailstation.station.station_name);$("#detailstation .station_nowplaying").html("Now playing: ...");if(site.chlist.isStarred(site.detailstation.station_id)){$("#detailstation .station_starred img").attr("src","img/icons-48/ic_starred_orange.png");}
else{$("#detailstation .station_starred img").attr("src","img/icons-48/ic_star.png");}
$("#detailstation .station_starred img").off("click");$("#detailstation .station_starred img").on("click",function(evt){site.chlist.toggleStarred(site.detailstation.station_id);if(site.chlist.isStarred(site.detailstation.station_id)){$("#detailstation .station_starred img").attr("src","img/icons-48/ic_starred_orange.png");site.chedit.changesHaveBeenMadeGotoStarred=true;}else{$("#detailstation .station_starred img").attr("src","img/icons-48/ic_star.png");}
site.chedit.changesHaveBeenMade=true;});site.detailstation.updateDataStationData();site.detailstation.updateDataNowPlaying();$("#detailstation .fab_header").off("click");$("#detailstation .fab_header").on("click",function(evt){var tmpobj={station_id:site.detailstation.station_id};site.chlist.selectstation(tmpobj);});$("#detailstation .recentlyplayed").off("click");$("#detailstation .recentlyplayed").on("click",function(evt){if(evt.originalEvent.target.parentNode&&evt.originalEvent.target.parentNode.className.indexOf("recentlyplayed")>=0||evt.originalEvent.target.parentNode.parentNode&&evt.originalEvent.target.parentNode.parentNode.className.indexOf("recentlyplayed")>=0){site.detailstation.drawRecentlyPlayed();}});$("#detailstation .editdetails").off("click");$("#detailstation .editdetails").on("click",function(evt){site.chedit.init(site.detailstation.station_id);});}
site.detailstation.updateDataStationData=function(){loggr.log("site.detailstation.updateDataStationData()");if(!site.detailstation.station.dirble_id){site.ui.showtoast("Dirble info not available :(");site.detailstation.updatedDataStationData();return; }
var apiqueryobj={"get":"station_info_dirble_v2","dirble_id":site.detailstation.station.dirble_id}
var apiaction="get";var apiquerystr=JSON.stringify(apiqueryobj);site.webapi.exec(apiaction,apiquerystr,function(data){data=data["data"];site.detailstation.stationDirble=data;var apiqueryobj={"get":"playlist_dirble_v2","dirble_id":site.detailstation.station.dirble_id}
var apiaction="get";var apiquerystr=JSON.stringify(apiqueryobj);site.webapi.exec(apiaction,apiquerystr,function(data){data=data["data"];site.detailstation.stationPlaylist=data;var subtitle="";for(var i=0;i<3;i++){if(!data[i]){break;}
subtitle+=data[i].title+", ";}
subtitle+="...";$("#detailstation .recentlyplayed .subtitle").html(subtitle);site.detailstation.updatedDataStationData();},function(error){if(error.message){site.ui.showtoast(error.message);loggr.warn(error.message);}
else{loggr.log(error);}
site.ui.showtoast("Recently played not available :(");site.detailstation.updatedDataStationData();});},function(error){if(error.message){site.ui.showtoast(error.message);loggr.warn(error.message);}
else{loggr.log(error);}
site.ui.showtoast("Recently played not available :(");site.detailstation.updatedDataStationData();});}
site.detailstation.updatedDataStationData=function(){site.detailstation.loadedStationData=true;site.detailstation.updatedData();}
site.detailstation.updateDataNowPlaying=function(){loggr.log("site.detailstation.updateDataNowPlaying()");site.ui.showLoadbar();var apiqueryobj={"get":"station_info","station_id":site.detailstation.station.station_id,"station_host":site.detailstation.station.station_host,"station_port":site.detailstation.station.station_port,"station_path":site.detailstation.station.station_path}
var apiaction="get";var apiquerystr=JSON.stringify(apiqueryobj);site.detailstation.nowPlayingAjaxReqIdentifier=site.webapi.exec(apiaction,apiquerystr,function(data){$("#detailstation .station_nowplaying").html(site.home.formatNowPlaying(data["data"]["nowplaying"]));site.detailstation.updatedDataNowPlaying();var someinfo=""
+"Server: "+data["data"]["server"]+", "
+"Content-type: "+data["data"]["content-type"]+", "
+"Bitrate: "+data["data"]["icy-br"];loggr.log(" > "+someinfo);},function(error){if(error.message){site.ui.showtoast(error.message);loggr.warn(error.message);}
else{loggr.log(error);}
$("#detailstation .station_nowplaying").html("Now playing: Unknown");site.detailstation.updatedDataNowPlaying();});}
site.detailstation.updatedDataNowPlaying=function(){site.detailstation.loadedNowPlaying=true;site.detailstation.updatedData();}
site.detailstation.updatedData=function(){if(site.detailstation.loadedStationData&&site.detailstation.loadedNowPlaying){loggr.debug("site.detailstation.updatedData() > Done!");site.ui.hideLoadbar("#detailstation");$("#detailstation .content").css("display","block");$("#detailstation .content_loading").css("display","none");if(!site.detailstation.stationPlaylist){$("#detailstation .recentlyplayed").css("display","none");}else{$("#detailstation .recentlyplayed").css("display","block");}}}
site.detailstation.drawRecentlyPlayed=function(closeit){loggr.debug("site.detailstation.drawRecentlyPlayed()");if(site.detailstation.stationPlaylist.length<=0){alert("Recently played not available");return; }
if($("#detailstation .recentlyplayed .inline_list").length>0||closeit){site.detailstation.hideRecentlyPlayed();return;}
$("#detailstation .recentlyplayed .icon img").attr("src","img/icons-48/ic_collapse_black.png");var inline_list=document.createElement("div");inline_list.className="inline_list";site.detailstation.timemsOffset=-1;var npparts=$("#detailstation .station_nowplaying").html().split(" - ");var npartist=npparts[0];var nptitle=(npparts[1])?npparts[1]:"Not available";var nowItemData={name:npartist,title:nptitle};site.detailstation.buildRecentlyPlayedItem(inline_list,nowItemData);for(var i=0;i<site.detailstation.stationPlaylist.length;i++){var playlistItemData=site.detailstation.stationPlaylist[i];site.detailstation.buildRecentlyPlayedItem(inline_list,playlistItemData);}
var divider=document.createElement("div");divider.className="divider";inline_list.appendChild(divider);$("#detailstation .recentlyplayed").append(inline_list);$("#detailstation .recentlyplayed").css("height",73+((site.detailstation.stationPlaylist.length+1)*72));$(inline_list).css("height",(site.detailstation.stationPlaylist.length+1)*72);}
site.detailstation.buildRecentlyPlayedItem=function(inline_list,playlistItemData){if(!playlistItemData){loggr.warn("site.detailstation.buildRecentlyPlayedItem() > !playlistItemData",{dontsave:true});return;}
var timeago=null;if(playlistItemData["date"]){var timems=Date.parse(playlistItemData["date"]);if(site.detailstation.timemsOffset<0){site.detailstation.timemsOffset=timems-new Date().getTime();if(site.detailstation.timemsOffset<0){site.detailstation.timemsOffset=0;}}
timems-=site.detailstation.timemsOffset;var date=new Date();date.setTime(timems);loggr.warn(" > "+date.format("Y-m-d H:i")+", "+Math.floor((new Date().getTime()-timems)/1000)+", "+Math.floor(site.detailstation.timemsOffset/1000),{dontsave:true});timems=new Date().getTime()-timems;var minutesAgo=Math.floor(timems/1000/60);var hoursAgo=Math.floor(minutesAgo/60);var daysAgo=Math.floor(hoursAgo/24);if(minutesAgo<=0){timeago="Now"}
else if(minutesAgo<=59){timeago=minutesAgo+"m";}
else if(hoursAgo<=23){timeago=hoursAgo+"h";}
else{timeago=daysAgo+"d";}}
var plitem=document.createElement("div");plitem.className="playlist_item";var pltimeago=document.createElement("div");pltimeago.className="playlist_item_timeago";pltimeago.innerHTML=(timeago!=null)?timeago:"Now";var plname=document.createElement("div");plname.className="playlist_item_name";plname.innerHTML=site.helpers.capAll(playlistItemData["name"]);var pltitle=document.createElement("div");pltitle.className="playlist_item_title";pltitle.innerHTML=site.helpers.capAll(playlistItemData["title"]);var plspotify=new Image();plspotify.className="playlist_item_spotify activatablel";plspotify.src="img/icons-48/ic_spotify_black.png";plspotify.title="Search track on Spotify";plspotify.sartist=encodeURI(playlistItemData["name"]);plspotify.stitle=encodeURI(playlistItemData["title"]);plspotify.onclick=function(){window.open("https://play.google.com/store/search?c=music&q="+this.sartist+" "+this.stitle,"_system");};var plsgpmusic=new Image();plsgpmusic.className="playlist_item_gpmusic activatablel";plsgpmusic.src="img/icons-48/ic_googleplaymusic_black.png";plsgpmusic.title="Search track on Google Play Music";plsgpmusic.sartist=encodeURI(playlistItemData["name"]);plsgpmusic.stitle=encodeURI(playlistItemData["title"]);plsgpmusic.onclick=function(){window.open("https://play.google.com/store/search?c=music&q="+this.sartist+" "+this.stitle,"_system");};plitem.appendChild(pltimeago);plitem.appendChild(plname);plitem.appendChild(pltitle);plitem.appendChild(plspotify);plitem.appendChild(plsgpmusic);inline_list.appendChild(plitem);}
site.detailstation.hideRecentlyPlayed=function(){$("#detailstation .recentlyplayed .icon img").attr("src","img/icons-48/ic_recentlyplayed_black.png");$("#detailstation .recentlyplayed").css("height",72);setTimeout(function(){$("#detailstation .recentlyplayed .inline_list").remove();},500);}
site.detailstation.handleColorize=function(imgobj){var vibrant=new Vibrant(imgobj,32,10);var swatches=vibrant.swatches();if(swatches["Vibrant"]){$("#detailstation .main .header").css("background-color",swatches["Vibrant"].getHex());}else{$("#detailstation .main .header").css("background-color","#455A64");}}